# Copyright 2017-2021 Authors of Cilium
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This image is used to extract proxylib/libcilium.so only for "tests" target.
CILIUM_REF=quay.io/cilium/cilium:stable

CHECK_FORMAT ?= ./bazel-bin/check_format.py

BAZEL_CACHE ?= ~/.cache/bazel
BAZEL_ARCHIVE ?= ~/bazel-cache.tar.bz2
CLANG_FORMAT ?= clang-format-15
BUILDIFIER ?= ~/go/bin/buildifier
BUILDOZER ?= ~/go/bin/buildozer

all: precheck envoy-default

# @envoy_api//:v3_protos must be built before invoking Makefile.api
API_DEPS = @envoy_api//:v3_protos
PROTOC_TARGET = @com_google_protobuf//:protoc
api: force-non-root Makefile.api install-bazel
	PROTOC=`$(BAZEL) cquery --output=starlark --starlark:expr=target.files_to_run.executable.path $(PROTOC_TARGET) | grep fastbuild/bin/external`; \
	$(BAZEL) build $(PROTOC_TARGET) $(API_DEPS); \
	file $${PROTOC} && PROTOC=$${PROTOC} $(MAKE) -f Makefile.api all

api-clean:
	find go -name *.pb.go -delete
	find go -name *.pb.validate.go -delete
	find go -empty -type d -delete
	mkdir -p go/contrib/envoy
	mkdir go/envoy

envoy-default: $(COMPILER_DEP) SOURCE_VERSION install-bazel
	@$(ECHO_BAZEL)
	$(BAZEL) $(BAZEL_OPTS) build $(BAZEL_BUILD_OPTS) //:cilium-envoy $(BAZEL_FILTER)

debug: envoy-debug

envoy-debug: $(COMPILER_DEP) SOURCE_VERSION install-bazel
	@$(ECHO_BAZEL)
	$(BAZEL) $(BAZEL_OPTS) build $(BAZEL_BUILD_OPTS) -c dbg //:cilium-envoy $(BAZEL_FILTER)

$(CHECK_FORMAT): force-non-root SOURCE_VERSION install-bazel
	$(BAZEL) $(BAZEL_OPTS) build $(BAZEL_BUILD_OPTS) //:check_format.py

veryclean: force-non-root clean
	-sudo $(BAZEL) $(BAZEL_OPTS) clean
	-sudo rm -Rf $(BAZEL_CACHE)

precheck: force-non-root
	tools/check_repositories.sh

~/go/bin/buildifier:
	go install github.com/bazelbuild/buildtools/buildifier@latest

~/go/bin/buildozer:
	go install github.com/bazelbuild/buildtools/buildozer@latest

check: $(CHECK_FORMAT) $(BUILDIFIER) $(BUILDOZER) force-non-root
	CLANG_FORMAT=$(CLANG_FORMAT) BUILDIFIER=$(BUILDIFIER) BUILDOZER=$(BUILDOZER) $(CHECK_FORMAT) --skip_envoy_build_rule_check --add-excluded-prefixes "./linux/" "./proxylib/" --bazel_tools_check_excluded_paths="./" --build_fixer_check_excluded_paths="./" check

fix: $(CHECK_FORMAT) $(BUILDIFIER) $(BUILDOZER) force-non-root
	CLANG_FORMAT=$(CLANG_FORMAT) BUILDIFIER=$(BUILDIFIER) BUILDOZER=$(BUILDOZER) $(CHECK_FORMAT) --skip_envoy_build_rule_check --add-excluded-prefixes "./linux/" "./proxylib/" --bazel_tools_check_excluded_paths="." --build_fixer_check_excluded_paths="./" fix

# Fetch proxylib for the target architecture.
# Run rule even if file exists, as it can be for a wrong architecture.
# This is only used for local tests runs, as this Makefile.dev is not imported to Docker test runs.
.PHONY: proxylib/libcilium.so
proxylib/libcilium.so:
	if ! file $@ | grep $(subst amd64,x86-64,$(subst arm64,aarch64,$(TARGETARCH))); then \
		PROXYLIB_DIGEST=$$(docker buildx imagetools inspect quay.io/cilium/cilium:stable --raw | jq -r '.manifests[] | select(.platform.architecture == "$(TARGETARCH)") | .digest') && \
		docker create -ti --name cilium-proxylib $(CILIUM_REF)@$${PROXYLIB_DIGEST} bash && \
		docker cp -L cilium-proxylib:/usr/lib/libcilium.so $@ && \
		docker rm -fv cilium-proxylib ; \
	fi

# Run tests without debug by default.
tests:  $(COMPILER_DEP) proxylib/libcilium.so force-non-root SOURCE_VERSION install-bazel
	$(BAZEL) $(BAZEL_OPTS) test $(BAZEL_BUILD_OPTS) //:envoy_binary_test $(BAZEL_FILTER)
	$(BAZEL) $(BAZEL_OPTS) test $(BAZEL_BUILD_OPTS) $(BAZEL_TEST_OPTS) //tests/... $(BAZEL_FILTER)

debug-tests:  $(COMPILER_DEP) proxylib/libcilium.so force-non-root SOURCE_VERSION install-bazel
	$(BAZEL) $(BAZEL_OPTS) test $(BAZEL_BUILD_OPTS) -c dbg $(BAZEL_TEST_OPTS) //:envoy_binary_test $(BAZEL_FILTER)
	$(BAZEL) $(BAZEL_OPTS) test $(BAZEL_BUILD_OPTS) -c dbg $(BAZEL_TEST_OPTS) //tests/... $(BAZEL_FILTER)
