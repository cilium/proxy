# =====================================================================
# Envoy specific Bazel build/test options.
# =====================================================================

# Keep envoy.bazelrc up-to-date by run:
# curl -sSL https://raw.githubusercontent.com/envoyproxy/envoy-wasm/master/.bazelrc > envoy.bazelrc
import %workspace%/envoy.bazelrc

# Use platforms based toolchain resolution
build --incompatible_enable_cc_toolchain_resolution
build --platform_mappings=bazel/platform_mappings

# Enable path normalization by default.
# See: https://github.com/envoyproxy/envoy/pull/6519
build --define path_normalization_by_default=true

# release builds are optimized
build:release -c opt

# No debug info for release builds
build:release --define no_debug_info=1
build:release --linkopt=-Wl,--strip-all
build --features=-per_object_debug_info
build --fission=dbg

# Manual link stamping, forces link to include current git SHA even if binary is otherwise
# upto-date
build:release --define manual_stamp=manual_stamp

# release_debug - an optimized release build containing the debug information
build:release_debug -c opt
build:release_debug --define no_debug_info=0
build:release_debug --strip=never
build:release_debug --copt=-ggdb3
build:release_debug --define manual_stamp=manual_stamp

# Always have LD_LIBRARY_PATH=/usr/cross-compat/lib defined in the test environment.
# The path does not need to exist, but can be created when needed for running tests.
build --test_env=LD_LIBRARY_PATH=/usr/cilium-cross-compat/lib

# use same env option for query as upstream is using for build
query --incompatible_merge_fixed_and_default_shell_env
