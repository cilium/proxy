From 2042f66eda6d2408bbd36c48ca9adb60f827093a Mon Sep 17 00:00:00 2001
From: Jarno Rajahalme <jarno@isovalent.com>
Date: Mon, 10 Jan 2022 14:51:49 +0200
Subject: [PATCH 01/11] build: Cross-compilation fixes

Signed-off-by: Jarno Rajahalme <jarno@isovalent.com>
---
 bazel/envoy_build_system.bzl |  6 ------
 bazel/foreign_cc/BUILD       | 19 ++++++++++++++++++-
 2 files changed, 18 insertions(+), 7 deletions(-)

diff --git a/bazel/envoy_build_system.bzl b/bazel/envoy_build_system.bzl
index f48ebe7056..a682b2ad78 100644
--- a/bazel/envoy_build_system.bzl
+++ b/bazel/envoy_build_system.bzl
@@ -101,7 +101,6 @@ def envoy_cmake(
         copy_pdb = False,
         pdb_name = "",
         cmake_files_dir = "$BUILD_TMPDIR/CMakeFiles",
-        generate_crosstool_file = False,
         **kwargs):
     cache_entries.update({"CMAKE_BUILD_TYPE": "Bazel"})
     cache_entries_debug = dict(cache_entries)
@@ -135,11 +134,6 @@ def envoy_cmake(
         targets = ["", "install"],
         # TODO: Remove install target and make this work
         install = False,
-        # TODO(lizan): Make this always true
-        generate_crosstool_file = select({
-            "@envoy//bazel:windows_x86_64": True,
-            "//conditions:default": generate_crosstool_file,
-        }),
         lib_source = lib_source,
         postfix_script = pf,
         **kwargs
diff --git a/bazel/foreign_cc/BUILD b/bazel/foreign_cc/BUILD
index 6c59c4266d..5c33aacb0f 100644
--- a/bazel/foreign_cc/BUILD
+++ b/bazel/foreign_cc/BUILD
@@ -25,6 +25,8 @@ configure_make(
         "--disable-libunwind",
     ] + select({
         "//bazel:apple": ["AR=/usr/bin/ar"],
+        "//bazel:linux_aarch64": ["--host aarch64-linux-gnu"],
+        "//bazel:linux_x86_64": ["--host x86_64-linux-gnu"],
         "//conditions:default": [],
     }),
     lib_source = "@com_github_gperftools_gperftools//:all",
@@ -84,6 +86,14 @@ configure_make(
         "//bazel:asan_build": {"ENVOY_CONFIG_ASAN": "1"},
         "//bazel:msan_build": {"ENVOY_CONFIG_MSAN": "1"},
         "//bazel:windows_dbg_build": {"WINDOWS_DBG_BUILD": "debug"},
+        "//bazel:linux_aarch64": {
+            "CC": "gcc",
+            "CROSS": "aarch64-linux-gnu-",
+        },
+        "//bazel:linux_x86_64": {
+            "CC": "gcc",
+            "CROSS": "x86_64-linux-gnu-",
+        },
         "//conditions:default": {},
     }),
     lib_source = "@com_github_luajit_luajit//:all",
@@ -104,6 +114,14 @@ configure_make(
         # TODO(htuch): Remove when #6084 is fixed
         "//bazel:asan_build": {"ENVOY_CONFIG_ASAN": "1"},
         "//bazel:msan_build": {"ENVOY_CONFIG_MSAN": "1"},
+        "//bazel:linux_aarch64": {
+            "CC": "gcc",
+            "CROSS": "aarch64-linux-gnu-",
+        },
+        "//bazel:linux_x86_64": {
+            "CC": "gcc",
+            "CROSS": "x86_64-linux-gnu-",
+        },
         "//conditions:default": {},
     }),
     lib_source = "@com_github_moonjit_moonjit//:all",
@@ -263,7 +281,6 @@ envoy_cmake(
         "CMAKE_CXX_COMPILER_FORCED": "on",
     },
     defines = ["CURL_STATICLIB"],
-    generate_crosstool_file = True,
     lib_source = "@com_github_curl//:all",
     out_static_libs = select({
         "//bazel:windows_x86_64": ["libcurl.lib"],
-- 
2.36.0

