From d7b8b64ff507f8f335bc53b2eb0b7d19fdf007ef Mon Sep 17 00:00:00 2001
From: Jarno Rajahalme <jarno@isovalent.com>
Date: Fri, 27 Jan 2023 22:13:31 +0200
Subject: [PATCH 11/11] boringssl: Compat with cross-compile using legacy
 cpu-flag

Signed-off-by: Jarno Rajahalme <jarno@isovalent.com>
---
 ...ype-cpu-flag-to-detect-target-platfo.patch | 43 +++++++++++++++++++
 bazel/repositories.bzl                        |  5 ++-
 2 files changed, 47 insertions(+), 1 deletion(-)
 create mode 100644 bazel/0001-bazel-Use-old-stype-cpu-flag-to-detect-target-platfo.patch

diff --git a/bazel/0001-bazel-Use-old-stype-cpu-flag-to-detect-target-platfo.patch b/bazel/0001-bazel-Use-old-stype-cpu-flag-to-detect-target-platfo.patch
new file mode 100644
index 0000000000..38d09a86fa
--- /dev/null
+++ b/bazel/0001-bazel-Use-old-stype-cpu-flag-to-detect-target-platfo.patch
@@ -0,0 +1,43 @@
+From a807c59b46421118243cbc2f5b43427c930a1e7c Mon Sep 17 00:00:00 2001
+From: Jarno Rajahalme <jarno@isovalent.com>
+Date: Fri, 27 Jan 2023 20:35:17 +0200
+Subject: [PATCH] bazel: Use old-stype cpu-flag to detect target platform
+
+Needed for compatibility with cilium/proxy toolchains.
+
+Signed-off-by: Jarno Rajahalme <jarno@isovalent.com>
+---
+ BUILD | 10 ++++++----
+ 1 file changed, 6 insertions(+), 4 deletions(-)
+
+diff --git a/BUILD b/BUILD
+index cfa695a44..915ac1c27 100644
+--- a/BUILD
++++ b/BUILD
+@@ -38,17 +38,19 @@ exports_files(["LICENSE"])
+ config_setting(
+     name = "linux_aarch64",
+     constraint_values = [
+-        "@platforms//os:linux",
+-        "@platforms//cpu:aarch64",
++#        "@platforms//os:linux",
++#        "@platforms//cpu:aarch64",
+     ],
++    values = {"cpu": "aarch64"},
+ )
+ 
+ config_setting(
+     name = "linux_x86_64",
+     constraint_values = [
+-        "@platforms//os:linux",
+-        "@platforms//cpu:x86_64",
++#        "@platforms//os:linux",
++#        "@platforms//cpu:x86_64",
+     ],
++    values = {"cpu": "k8"},
+ )
+ 
+ config_setting(
+-- 
+2.36.0
+
diff --git a/bazel/repositories.bzl b/bazel/repositories.bzl
index be2b50b7e4..47b5cfa5ab 100644
--- a/bazel/repositories.bzl
+++ b/bazel/repositories.bzl
@@ -257,7 +257,10 @@ def _boringssl():
     external_http_archive(
         name = "boringssl",
         patch_args = ["-p1"],
-        patches = ["@envoy//bazel:boringssl_static.patch"],
+        patches = [
+            "@envoy//bazel:boringssl_static.patch",
+            "@envoy//bazel:0001-bazel-Use-old-stype-cpu-flag-to-detect-target-platfo.patch"
+	],
     )
 
 def _boringssl_fips():
-- 
2.36.0

