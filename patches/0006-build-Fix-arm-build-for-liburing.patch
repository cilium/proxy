From e994434cc738138434708372719517b31fdc81c5 Mon Sep 17 00:00:00 2001
From: Tam Mach <sayboras@yahoo.com>
Date: Wed, 14 May 2025 11:27:14 +1000
Subject: [PATCH 6/7] build: Fix cross-compilation for liburing

---
 bazel/foreign_cc/BUILD | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

diff --git a/bazel/foreign_cc/BUILD b/bazel/foreign_cc/BUILD
index dc07b536d3..6c49ca1cb0 100644
--- a/bazel/foreign_cc/BUILD
+++ b/bazel/foreign_cc/BUILD
@@ -28,6 +28,28 @@ config_setting(
 configure_make(
     name = "liburing",
     configure_in_place = True,
+    env = select({
+        # (sayboras) Ideally, this should be passed as part of environment variables during cross-compilation,
+        # but somehow it doesn't work. So, we have to pass them manually for cross-compilation.
+        # The config should be kept in sync with bazel/toolchains/BUILD
+        "//bazel:linux_aarch64": {
+            "CFLAGS": "-fPIC --target=aarch64-unknown-linux-gnu --sysroot=/usr/aarch64-linux-gnu/sys-root -fuse-ld=lld-18",
+            "CPPFLAGS": "--target=aarch64-unknown-linux-gnu --sysroot=/usr/aarch64-linux-gnu/sys-root -fuse-ld=lld-18",
+            "LDFLAGS": "-Wl,-S --target=aarch64-unknown-linux-gnu --sysroot=/usr/aarch64-linux-gnu/sys-root -fuse-ld=lld-18 -stdlib=libc++ -Wl,-no-as-needed -Wl,-z,relro,-z,now -lm -l:libc++.a -l:libc++abi.a -lpthread -lc",
+            "CC": "/usr/bin/clang-18",
+            "CXX": "/usr/bin/clang-18",
+            "LD": "/usr/bin/lld-18",
+        },
+        "//bazel:linux_x86_64": {
+            "CFLAGS": "-fPIC --target=x86_64-unknown-linux-gnu --sysroot=/usr/x86_64-linux-gnu/sys-root -fuse-ld=lld-18",
+            "CPPFLAGS": "--target=x86_64-unknown-linux-gnu --sysroot=/usr/x86_64-linux-gnu/sys-root -fuse-ld=lld-18",
+            "LDFLAGS": "-Wl,-S --target=x86_64-unknown-linux-gnu --sysroot=/usr/x86_64-linux-gnu/sys-root -fuse-ld=lld-18 -stdlib=libc++ -Wl,-no-as-needed -Wl,-z,relro,-z,now -lm -l:libc++.a -l:libc++abi.a -lpthread -lc",
+            "CC": "/usr/bin/clang-18",
+            "CXX": "/usr/bin/clang-18",
+            "LD": "/usr/bin/lld-18",
+        },
+        "//conditions:default": {},
+    }),
     lib_source = "@com_github_axboe_liburing//:all",
     tags = [
         "nocompdb",
--
2.43.0
