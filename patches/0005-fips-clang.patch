From c7f09cf9e314f2c09755f5d7053d04f48047abaf Mon Sep 17 00:00:00 2001
From: Ryan Northey <ryan@synca.io>
Date: Wed, 13 Mar 2024 19:19:12 +0000
Subject: [PATCH] fips/build: Add `-fPIC`

Signed-off-by: Ryan Northey <ryan@synca.io>
---
 bazel/external/boringssl_fips.genrule_cmd | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/bazel/external/boringssl_fips.genrule_cmd b/bazel/external/boringssl_fips.genrule_cmd
index 46526a9a84..44f21fc9c5 100755
--- a/bazel/external/boringssl_fips.genrule_cmd
+++ b/bazel/external/boringssl_fips.genrule_cmd
@@ -119,7 +119,9 @@ rm -rf boringssl/build
 
 # Build BoringSSL.
 cd boringssl
-mkdir build && cd build && cmake -GNinja -DCMAKE_TOOLCHAIN_FILE=${HOME}/toolchain -DFIPS=1 -DCMAKE_BUILD_TYPE=Release ..
+# Setting -fPIC only affects the compilation of the non-module code in libcrypto.a,
+# because the FIPS module itself is already built with -fPIC.
+mkdir build && cd build && cmake -GNinja -DCMAKE_TOOLCHAIN_FILE=${HOME}/toolchain -DFIPS=1 -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_FLAGS="-fPIC" -DCMAKE_CXX_FLAGS="-fPIC" ..
 ninja
 ninja run_tests
 ./crypto/crypto_test
-- 
2.44.0

